<div class="orders-container">
  <!-- Header -->
  <div class="orders-header">
    <div>
      <h1>Orders</h1>
      <p class="subtitle">Manage customer orders</p>
    </div>
    <div class="header-actions">
      @if (auth.isAdmin()) {
        <button class="btn-record" (click)="openAddOrderModal()">
          <lucide-icon name="circle-plus" size="20"></lucide-icon>
          Record Order
        </button>
        <button class="btn-primary" (click)="exportOrders()">
          <lucide-icon name="download" size="18"></lucide-icon>
          Export Orders
        </button>
      }
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon total">
        <lucide-icon name="shopping-bag" size="24"></lucide-icon>
      </div>
      <div class="stat-content">
        <p class="stat-label">Total Orders</p>
        <h3 class="stat-value">{{ stats.total }}</h3>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon pending">
        <lucide-icon name="clock" size="24"></lucide-icon>
      </div>
      <div class="stat-content">
        <p class="stat-label">Pending</p>
        <h3 class="stat-value">{{ stats.pending }}</h3>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon processing">
        <lucide-icon name="package" size="24"></lucide-icon>
      </div>
      <div class="stat-content">
        <p class="stat-label">Processing</p>
        <h3 class="stat-value">{{ stats.processing }}</h3>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon completed">
        <lucide-icon name="circle-check" size="24"></lucide-icon>
      </div>
      <div class="stat-content">
        <p class="stat-label">Completed</p>
        <h3 class="stat-value">{{ stats.completed }}</h3>
      </div>
    </div>

    <div class="stat-card revenue">
      <div class="stat-icon revenue-icon">
        <lucide-icon name="dollar-sign" size="24"></lucide-icon>
      </div>
      <div class="stat-content">
        <p class="stat-label">Total Revenue</p>
        <h3 class="stat-value">${{ stats.totalRevenue.toLocaleString() }}</h3>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-bar">
      <lucide-icon name="search" size="20" class="search-icon"></lucide-icon>
      <input
        type="text"
        placeholder="Search orders, products, customers..."
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        class="search-input"
      >
    </div>

    <div class="status-filter">
      <lucide-icon name="sliders-horizontal" size="18"></lucide-icon>
      <div class="custom-dropdown" (click)="toggleStatusFilterDropdown()">
        <div class="dropdown-selected">
          @if (selectedStatus !== 'all') {
            <lucide-icon [name]="getStatusIcon(selectedStatus)" size="16"></lucide-icon>
          }
          <span>{{ getStatusFilterLabel() }}</span>
          <lucide-icon name="chevron-down" size="16" [class.rotate]="showStatusFilterDropdown"></lucide-icon>
        </div>
        @if (showStatusFilterDropdown) {
          <div class="dropdown-options" (click)="$event.stopPropagation()">
            <div class="dropdown-option" [class.selected]="selectedStatus === 'all'" (click)="selectStatusFilter('all')">
              <span>All Orders</span>
            </div>
            <div class="dropdown-option" [class.selected]="selectedStatus === 'pending'" (click)="selectStatusFilter('pending')">
              <lucide-icon name="clock" size="16"></lucide-icon>
              <span>Pending</span>
            </div>
            <div class="dropdown-option" [class.selected]="selectedStatus === 'processing'" (click)="selectStatusFilter('processing')">
              <lucide-icon name="loader-circle" size="16"></lucide-icon>
              <span>Processing</span>
            </div>
            <div class="dropdown-option" [class.selected]="selectedStatus === 'completed'" (click)="selectStatusFilter('completed')">
              <lucide-icon name="circle-check" size="16"></lucide-icon>
              <span>Completed</span>
            </div>
            <div class="dropdown-option" [class.selected]="selectedStatus === 'cancelled'" (click)="selectStatusFilter('cancelled')">
              <lucide-icon name="ban" size="16"></lucide-icon>
              <span>Cancelled</span>
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading">
      <lucide-icon name="loader-circle" size="32" class="spin"></lucide-icon>
      <p>Loading orders...</p>
    </div>
  }

<!-- Orders Table -->
<div class="orders-table">
  <table>
    <thead>
      <tr>
        <th>Order #</th>
        <th>Product</th>
        <th>Customer</th>
        <th>Quantity</th>
        <th>Total</th>
        <th>Date</th>
        <th>Status</th>
        <th>Assigned To</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- ✅ FONTOS: Ez a @for ciklus kell! -->
      @for (order of filteredOrders; track order.id) {
        <tr>
          <td><strong>{{ order.orderNumber }}</strong></td>
          <td>{{ order.product }}</td>
          <td>{{ order.customer }}</td>
          <td>{{ order.quantity }}</td>
          <td>${{ order.totalAmount.toFixed(2) }}</td>
          <td>{{ order.date }}</td>
          <td>
            <span class="status-badge" [ngClass]="'status-' + order.status">
              {{ order.status }}
            </span>
          </td>
          <td>
            @if (auth.isAdmin()) {
              <select 
                [value]="order.assignedTo || ''" 
                (change)="assignOrderToWorker(order.id, $any($event.target).value)"
                class="worker-select"
                [disabled]="assigningOrder === order.id"
              >
                <option value="">Unassigned</option>
                <option *ngFor="let worker of workers" [value]="worker.id">
                  {{ worker.username }}
                </option>
              </select>
            } @else {
              <span class="worker-badge">{{ getWorkerName(order.assignedTo) }}</span>
            }
          </td>
          <td>
            <!-- Actions buttons if you have any -->
          </td>
        </tr>
      }
      
      <!-- Empty state -->
      @if (filteredOrders.length === 0) {
        <tr>
          <td colspan="9" class="empty-state">
            <lucide-icon name="inbox" size="48"></lucide-icon>
            <p>No orders found</p>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>

  <!-- Empty State -->
@if (!isLoading && filteredOrders.length === 0) {
  <div class="empty-state">
    <lucide-icon name="shopping-bag" size="64" class="empty-icon"></lucide-icon>  <!-- ✅ Confirmed correct -->
    <h3>No orders found</h3>
    <p>{{ searchTerm || selectedStatus !== 'all' ? 'Try adjusting your filters' : 'Orders will appear here when customers make purchases' }}</p>
  </div>
}

  <!-- Order Details Modal -->
  @if (showDetailsModal && selectedOrder) {
    <div class="modal-overlay" (click)="closeDetailsModal()">
      <div class="modal-content details-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div>
            <h2>Order Details</h2>
            <p class="order-number-header">{{ selectedOrder.orderNumber }}</p>
          </div>
          <button aria-label="Bezárás" class="btn-close" (click)="closeDetailsModal()">
            <lucide-icon name="x" size="24"></lucide-icon>
          </button>
        </div>

        <div class="modal-body">
          <div class="detail-section">
            <div class="detail-row">
              <span class="detail-label">Status</span>
              <span class="status-badge" [ngClass]="getStatusClass(selectedOrder.status)">
                <lucide-icon [name]="getStatusIcon(selectedOrder.status)" size="14"></lucide-icon>
                {{ selectedOrder.status }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Customer</span>
              <span class="detail-value">{{ selectedOrder.customer }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Date</span>
              <span class="detail-value">{{ formatDate(selectedOrder.date) }}</span>
            </div>
          </div>

          <div class="detail-section">
            <h3>Product Information</h3>
            <div class="detail-row">
              <span class="detail-label">Product</span>
              <span class="detail-value">{{ selectedOrder.product }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Quantity</span>
              <span class="detail-value">{{ selectedOrder.quantity }} units</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Unit Price</span>
              <span class="detail-value">${{ selectedOrder.unitPrice.toLocaleString() }}</span>
            </div>
          </div>

          <div class="detail-section total-section">
            <div class="detail-row total-row">
              <span class="detail-label">Total Amount</span>
              <span class="detail-value total-amount">${{ selectedOrder.totalAmount.toLocaleString() }}</span>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeDetailsModal()">Close</button>
          @if (auth.isAdmin() && selectedOrder.status !== 'cancelled' && selectedOrder.status !== 'completed') {
            <button class="btn-primary" (click)="openStatusModal(selectedOrder); closeDetailsModal()">
              Update Status
            </button>
          }
        </div>
      </div>
    </div>
  }

  <!-- Status Update Modal -->
  @if (showStatusModal && orderToUpdate) {
    <div class="modal-overlay" (click)="closeStatusModal()">
      <div class="modal-content status-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Update Order Status</h2>
          <button aria-label="Bezárás" class="btn-close" (click)="closeStatusModal()">
            <lucide-icon name="x" size="24"></lucide-icon>
          </button>
        </div>

        <div class="modal-body">
          <p class="modal-description">Update status for order {{ orderToUpdate.orderNumber }}</p>

          <div class="status-options">
            <label class="status-option" [class.selected]="newStatus === 'pending'">
              <input type="radio" name="status" value="pending" [(ngModel)]="newStatus">
              <div class="option-content">
                <lucide-icon name="clock" size="20"></lucide-icon>
                <span>Pending</span>
              </div>
            </label>

            <label class="status-option" [class.selected]="newStatus === 'processing'">
              <input type="radio" name="status" value="processing" [(ngModel)]="newStatus">
              <div class="option-content">
                <lucide-icon name="loader-circle" size="20"></lucide-icon>
                <span>Processing</span>
              </div>
            </label>

            <label class="status-option" [class.selected]="newStatus === 'completed'">
              <input type="radio" name="status" value="completed" [(ngModel)]="newStatus">
              <div class="option-content">
                <lucide-icon name="circle-check" size="20"></lucide-icon>
                <span>Completed</span>
              </div>
            </label>

            <label class="status-option" [class.selected]="newStatus === 'cancelled'">
              <input type="radio" name="status" value="cancelled" [(ngModel)]="newStatus">
              <div class="option-content">
                <lucide-icon name="ban" size="20"></lucide-icon>
                <span>Cancelled</span>
              </div>
            </label>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeStatusModal()">Cancel</button>
          <button class="btn-primary" (click)="updateOrderStatus()">Update Status</button>
        </div>
      </div>
    </div>
  }

  <!-- Cancel Confirmation Modal -->
  <app-confirmation-modal
    [show]="showCancelConfirm"
    [title]="'Cancel Order'"
    [message]="'Are you sure you want to cancel order ' + (orderToCancel?.orderNumber || '') + '? This action cannot be undone.'"
    [confirmText]="'Cancel Order'"
    [cancelText]="'Keep Order'"
    [confirmColor]="'danger'"
    [icon]="'ban'"
    (confirm)="cancelOrder()"
    (cancel)="closeCancelConfirm()">
  </app-confirmation-modal>
  <!-- Add Order Modal -->
@if (showAddOrderModal) {
  <div class="modal-overlay" (click)="closeAddOrderModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <lucide-icon name="circle-plus" size="24"></lucide-icon>
          Record New Order
        </h2>
        <button aria-label="Close" class="btn-close" (click)="closeAddOrderModal()">
          <lucide-icon name="x" size="24"></lucide-icon>
        </button>
      </div>

      <form (ngSubmit)="createOrder()" class="modal-body">
        @if (orderError) {
          <div class="modal-alert error">
            <lucide-icon name="circle-alert" size="20"></lucide-icon>
            {{ orderError }}
          </div>
        }

        @if (orderSuccess) {
          <div class="modal-alert success">
            <lucide-icon name="circle-check" size="20"></lucide-icon>
            {{ orderSuccess }}
          </div>
        }

        <!-- Product Selection -->
        <div class="form-group">
          <label for="product">Product *</label>
          <select
            id="product"
            [(ngModel)]="newOrder.item_id"
            name="product"
            class="form-select"
            (change)="onProductChange()"
            required
          >
            <option value="">Select a product</option>
            @for (product of products; track product.id) {
              <option [value]="product.id" [disabled]="product.amount === 0">
                {{ product.name }} - ${{ product.price?.toLocaleString() || 0 }}
                @if (product.amount > 0) {
                  ({{ product.amount }} in stock)
                } @else {
                  (Out of stock)
                }
              </option>
            }
          </select>
          @if (newOrder.item_id && getProductStock(newOrder.item_id) === 0) {
            <small class="error-hint">
              <lucide-icon name="alert-triangle" size="14"></lucide-icon>
              This product is out of stock
            </small>
          }
        </div>

        <!-- Customer Selection -->
        <div class="form-group">
          <label for="customer">Customer *</label>
          @if (!showNewCustomerForm) {
            <div class="customer-select-group">
              <select
                id="customer"
                [(ngModel)]="newOrder.customer_id"
                name="customer"
                class="form-select"
                required
              >
                <option value="">Select a customer</option>
                @for (customer of customers; track customer.id) {
                  <option [value]="customer.id">
                    {{ customer.name }} @if (customer.email) { ({{ customer.email }}) }
                  </option>
                }
              </select>
              <button aria-label="Add Customer" type="button" class="btn-add-customer" (click)="toggleNewCustomerForm()">
                <lucide-icon name="user-plus" size="18"></lucide-icon>
              </button>
            </div>
          } @else {
            <!-- New Customer Form -->
            <div class="new-customer-form">
              <input
                type="text"
                [(ngModel)]="newCustomer.name"
                name="customerName"
                class="form-input"
                placeholder="Customer name *"
                required
              />
              <input
                type="email"
                [(ngModel)]="newCustomer.email"
                name="customerEmail"
                class="form-input"
                placeholder="Email (optional)"
              />
              <input
                type="tel"
                [(ngModel)]="newCustomer.phone"
                name="customerPhone"
                class="form-input"
                placeholder="Phone (optional)"
              />
              <div class="customer-actions">
                <button type="button" class="btn-cancel" (click)="toggleNewCustomerForm()">
                  Cancel
                </button>
                <button type="button" class="btn-save" (click)="createCustomer()" [disabled]="isSavingCustomer">
                  @if (isSavingCustomer) {
                    <span class="spinner-small"></span>
                  } @else {
                    <lucide-icon name="check" size="18"></lucide-icon>
                  }
                  Create
                </button>
              </div>
            </div>
          }
        </div>

        <!-- Quantity -->
        <div class="form-group">
          <label for="quantity">Quantity *</label>
          <input
            type="number"
            id="quantity"
            [(ngModel)]="newOrder.quantity"
            name="quantity"
            class="form-input"
            (input)="onQuantityChange()"
            min="1"
            [max]="getProductStock(newOrder.item_id)"
            required
          />
          @if (newOrder.item_id) {
            <small class="stock-hint">
              <lucide-icon name="package" size="14"></lucide-icon>
              Available: {{ getProductStock(newOrder.item_id) }} units
            </small>
          }
        </div>

        <!-- Order Status -->
        <div class="form-group">
          <label for="status">Order Status *</label>
          <div class="custom-dropdown" (click)="toggleOrderStatusDropdown()">
            <div class="dropdown-selected">
              <lucide-icon [name]="getStatusIcon(newOrder.status)" size="16"></lucide-icon>
              <span>{{ newOrder.status.charAt(0).toUpperCase() + newOrder.status.slice(1) }}</span>
              <lucide-icon name="chevron-down" size="16" [class.rotate]="showOrderStatusDropdown"></lucide-icon>
            </div>
            @if (showOrderStatusDropdown) {
              <div class="dropdown-options" (click)="$event.stopPropagation()">
                <div class="dropdown-option" [class.selected]="newOrder.status === 'pending'" (click)="selectOrderStatus('pending')">
                  <lucide-icon name="clock" size="16"></lucide-icon>
                  <div class="option-details">
                    <span class="option-title">Pending</span>
                    <span class="option-desc">Awaiting processing</span>
                  </div>
                </div>
                <div class="dropdown-option" [class.selected]="newOrder.status === 'processing'" (click)="selectOrderStatus('processing')">
                  <lucide-icon name="loader-circle" size="16"></lucide-icon>
                  <div class="option-details">
                    <span class="option-title">Processing</span>
                    <span class="option-desc">Being prepared</span>
                  </div>
                </div>
                <div class="dropdown-option" [class.selected]="newOrder.status === 'completed'" (click)="selectOrderStatus('completed')">
                  <lucide-icon name="circle-check" size="16"></lucide-icon>
                  <div class="option-details">
                    <span class="option-title">Completed</span>
                    <span class="option-desc">Order fulfilled</span>
                  </div>
                </div>
                <div class="dropdown-option" [class.selected]="newOrder.status === 'cancelled'" (click)="selectOrderStatus('cancelled')">
                  <lucide-icon name="ban" size="16"></lucide-icon>
                  <div class="option-details">
                    <span class="option-title">Cancelled</span>
                    <span class="option-desc">Order cancelled</span>
                  </div>
                </div>
              </div>
            }
          </div>
          <small class="stock-hint">
            {{ getStatusDescription(newOrder.status) }}
          </small>
        </div>

        <!-- Order Summary -->
        @if (newOrder.item_id && newOrder.quantity > 0) {
          <div class="order-summary">
            <div class="summary-header">
              <lucide-icon name="calculator" size="18"></lucide-icon>
              <h3>Order Summary</h3>
            </div>
            <div class="summary-row">
              <span>Unit Price:</span>
              <span class="summary-value">${{ getSelectedProductPrice().toLocaleString() }}</span>
            </div>
            <div class="summary-row">
              <span>Quantity:</span>
              <span class="summary-value">{{ newOrder.quantity }} units</span>
            </div>
            <div class="summary-row total">
              <span>Total Amount:</span>
              <span class="summary-value total-amount">${{ calculateOrderTotal().toLocaleString() }}</span>
            </div>
            @if (newOrder.status === 'processing' || newOrder.status === 'completed') {
              <div class="stock-impact-note">
                <lucide-icon name="info" size="14"></lucide-icon>
                <span>Stock will be reduced by {{ newOrder.quantity }} units</span>
              </div>
            }
          </div>
        }

        <!-- Modal Footer -->
        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeAddOrderModal()">
            Cancel
          </button>
          <button type="submit" class="btn-submit" [disabled]="isSavingOrder || showNewCustomerForm">
            @if (isSavingOrder) {
              <span class="spinner-small"></span>
              Creating...
            } @else {
              <lucide-icon name="circle-check" size="18"></lucide-icon>
              Record Order
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}
</div>
